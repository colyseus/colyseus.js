{"version":3,"file":"H3Transport.js","sources":["../../../src/transport/H3Transport.ts"],"sourcesContent":["import { ITransport, ITransportEventMap } from \"./ITransport\";\r\nimport { encode, decode, Iterator } from '@colyseus/schema';\r\n\r\nexport class H3TransportTransport implements ITransport {\r\n    wt: WebTransport;\r\n    isOpen: boolean = false;\r\n\r\n    reader: ReadableStreamDefaultReader;\r\n    writer: WritableStreamDefaultWriter;\r\n\r\n    unreliableReader: ReadableStreamDefaultReader<Uint8Array>;\r\n    unreliableWriter: WritableStreamDefaultWriter<Uint8Array>;\r\n\r\n    private lengthPrefixBuffer = new Uint8Array(9); // 9 bytes is the maximum length of a length prefix\r\n\r\n    constructor(public events: ITransportEventMap) { }\r\n\r\n    public connect(url: string, options: any = {}) {\r\n        const wtOpts = options.fingerprint && ({\r\n            // requireUnreliable: true,\r\n            // congestionControl: \"default\", // \"low-latency\" || \"throughput\"\r\n\r\n            serverCertificateHashes: [{\r\n                algorithm: 'sha-256',\r\n                value: new Uint8Array(options.fingerprint).buffer\r\n            }]\r\n        }) || undefined;\r\n\r\n        this.wt = new WebTransport(url, wtOpts);\r\n\r\n        this.wt.ready.then((e) => {\r\n            console.log(\"WebTransport ready!\", e)\r\n            this.isOpen = true;\r\n\r\n            this.unreliableReader = this.wt.datagrams.readable.getReader();\r\n            this.unreliableWriter = this.wt.datagrams.writable.getWriter();\r\n\r\n            const incomingBidi = this.wt.incomingBidirectionalStreams.getReader();\r\n            incomingBidi.read().then((stream) => {\r\n                this.reader = stream.value.readable.getReader();\r\n                this.writer = stream.value.writable.getWriter();\r\n\r\n                // immediately write room/sessionId for establishing the room connection\r\n                this.sendSeatReservation(options.room.roomId, options.sessionId, options.reconnectionToken);\r\n\r\n                // start reading incoming data\r\n                this.readIncomingData();\r\n                this.readIncomingUnreliableData();\r\n\r\n            }).catch((e) => {\r\n                console.error(\"failed to read incoming stream\", e);\r\n                console.error(\"TODO: close the connection\");\r\n            });\r\n\r\n            // this.events.onopen(e);\r\n        }).catch((e: WebTransportCloseInfo) => {\r\n            // this.events.onerror(e);\r\n            // this.events.onclose({ code: e.closeCode, reason: e.reason });\r\n            console.log(\"WebTransport not ready!\", e)\r\n            this._close();\r\n        });\r\n\r\n        this.wt.closed.then((e: WebTransportCloseInfo) => {\r\n            console.log(\"WebTransport closed w/ success\", e)\r\n            this.events.onclose({ code: e.closeCode, reason: e.reason });\r\n\r\n        }).catch((e: WebTransportCloseInfo) => {\r\n            console.log(\"WebTransport closed w/ error\", e)\r\n            this.events.onerror(e);\r\n            this.events.onclose({ code: e.closeCode, reason: e.reason });\r\n        }).finally(() => {\r\n            this._close();\r\n        });\r\n    }\r\n\r\n    public send(data: Buffer | Uint8Array): void {\r\n        const prefixLength = encode.number(this.lengthPrefixBuffer, data.length, { offset: 0 });\r\n        const dataWithPrefixedLength = new Uint8Array(prefixLength + data.length);\r\n        dataWithPrefixedLength.set(this.lengthPrefixBuffer.subarray(0, prefixLength), 0);\r\n        dataWithPrefixedLength.set(data, prefixLength);\r\n        this.writer.write(dataWithPrefixedLength);\r\n    }\r\n\r\n    public sendUnreliable(data: Buffer | Uint8Array): void {\r\n        const prefixLength = encode.number(this.lengthPrefixBuffer, data.length, { offset: 0 });\r\n        const dataWithPrefixedLength = new Uint8Array(prefixLength + data.length);\r\n        dataWithPrefixedLength.set(this.lengthPrefixBuffer.subarray(0, prefixLength), 0);\r\n        dataWithPrefixedLength.set(data, prefixLength);\r\n        this.unreliableWriter.write(dataWithPrefixedLength);\r\n    }\r\n\r\n    public close(code?: number, reason?: string) {\r\n        try {\r\n            this.wt.close({ closeCode: code, reason: reason });\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    }\r\n\r\n    protected async readIncomingData() {\r\n        let result: ReadableStreamReadResult<Uint8Array>;\r\n\r\n        while (this.isOpen) {\r\n            try {\r\n                result = await this.reader.read();\r\n\r\n                //\r\n                // a single read may contain multiple messages\r\n                // each message is prefixed with its length\r\n                //\r\n\r\n                const messages = result.value;\r\n                const it: Iterator = { offset: 0 };\r\n                do {\r\n                    //\r\n                    // QUESTION: should we buffer the message in case it's not fully read?\r\n                    //\r\n\r\n                    const length = decode.number(messages, it);\r\n                    this.events.onmessage({ data: messages.subarray(it.offset, it.offset + length) });\r\n                    it.offset += length;\r\n                } while (it.offset < messages.length);\r\n\r\n            } catch (e) {\r\n                if (e.message.indexOf(\"session is closed\") === -1) {\r\n                    console.error(\"H3Transport: failed to read incoming data\", e);\r\n                }\r\n                break;\r\n            }\r\n\r\n            if (result.done) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    protected async readIncomingUnreliableData() {\r\n        let result: ReadableStreamReadResult<Uint8Array>;\r\n\r\n        while (this.isOpen) {\r\n            try {\r\n                result = await this.unreliableReader.read();\r\n\r\n                //\r\n                // a single read may contain multiple messages\r\n                // each message is prefixed with its length\r\n                //\r\n\r\n                const messages = result.value;\r\n                const it: Iterator = { offset: 0 };\r\n                do {\r\n                    //\r\n                    // QUESTION: should we buffer the message in case it's not fully read?\r\n                    //\r\n\r\n                    const length = decode.number(messages, it);\r\n                    this.events.onmessage({ data: messages.subarray(it.offset, it.offset + length) });\r\n                    it.offset += length;\r\n                } while (it.offset < messages.length);\r\n\r\n            } catch (e) {\r\n                if (e.message.indexOf(\"session is closed\") === -1) {\r\n                    console.error(\"H3Transport: failed to read incoming data\", e);\r\n                }\r\n                break;\r\n            }\r\n\r\n            if (result.done) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    protected sendSeatReservation (roomId: string, sessionId: string, reconnectionToken?: string) {\r\n        const it: Iterator = { offset: 0 };\r\n        const bytes: number[] = [];\r\n\r\n        encode.string(bytes, roomId, it);\r\n        encode.string(bytes, sessionId, it);\r\n\r\n        if (reconnectionToken) {\r\n            encode.string(bytes, reconnectionToken, it);\r\n        }\r\n\r\n        this.writer.write(new Uint8Array(bytes).buffer);\r\n    }\r\n\r\n    protected _close() {\r\n        this.isOpen = false;\r\n    }\r\n\r\n}\r\n"],"names":["encode","decode"],"mappings":"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"}