{"version":3,"file":"Auth.js","sources":["../../src/Auth.ts"],"sourcesContent":["import { HTTP } from \"./HTTP\";\r\nimport { getItem, removeItem, setItem } from \"./Storage\";\r\nimport { createNanoEvents } from './core/nanoevents';\r\n\r\nexport interface AuthSettings {\r\n    path: string;\r\n    key: string;\r\n}\r\n\r\nexport interface PopupSettings {\r\n    prefix: string;\r\n    width: number;\r\n    height: number;\r\n}\r\n\r\nexport interface AuthData {\r\n    user: any;\r\n    token: string;\r\n}\r\n\r\nexport class Auth {\r\n    settings: AuthSettings = {\r\n        path: \"/auth\",\r\n        key: \"colyseus-auth-token\",\r\n    };\r\n\r\n    #_initialized = false;\r\n    #_initializationPromise: Promise<void>;\r\n    #_signInWindow = undefined;\r\n    #_events = createNanoEvents();\r\n\r\n    constructor(protected http: HTTP) {\r\n        getItem(this.settings.key, (token) => this.token = token);\r\n    }\r\n\r\n    public set token(token: string) {\r\n        this.http.authToken = token;\r\n    }\r\n\r\n    public get token(): string {\r\n        return this.http.authToken;\r\n    }\r\n\r\n    public onChange(callback: (response: AuthData) => void) {\r\n        const unbindChange = this.#_events.on(\"change\", callback);\r\n        if (!this.#_initialized) {\r\n            this.#_initializationPromise = new Promise<void>((resolve, reject) => {\r\n                this.getUserData().then((userData) => {\r\n                    this.emitChange({ ...userData, token: this.token });\r\n\r\n                }).catch((e) => {\r\n                    // user is not logged in, or service is down\r\n                    this.emitChange({ user: null, token: undefined });\r\n\r\n                }).finally(() => {\r\n                    resolve();\r\n                });\r\n            });\r\n        }\r\n        this.#_initialized = true;\r\n        return unbindChange;\r\n    }\r\n\r\n    public async getUserData() {\r\n        if (this.token) {\r\n            return (await this.http.get(`${this.settings.path}/userdata`)).data;\r\n        } else {\r\n            throw new Error(\"missing auth.token\");\r\n        }\r\n    }\r\n\r\n    public async registerWithEmailAndPassword(email: string, password: string, options?: any) {\r\n        const data = (await this.http.post(`${this.settings.path}/register`, {\r\n            body: { email, password, options, },\r\n        })).data;\r\n\r\n        this.emitChange(data);\r\n\r\n        return data;\r\n    }\r\n\r\n    public async signInWithEmailAndPassword(email: string, password: string) {\r\n        const data = (await this.http.post(`${this.settings.path}/login`, {\r\n            body: { email, password, },\r\n        })).data;\r\n\r\n        this.emitChange(data);\r\n\r\n        return data;\r\n    }\r\n\r\n    public async signInAnonymously(options?: any) {\r\n        const data = (await this.http.post(`${this.settings.path}/anonymous`, {\r\n            body: { options, }\r\n        })).data;\r\n\r\n        this.emitChange(data);\r\n\r\n        return data;\r\n    }\r\n\r\n    public async sendPasswordResetEmail(email: string) {\r\n        return (await this.http.post(`${this.settings.path}/forgot-password`, {\r\n            body: { email, }\r\n        })).data;\r\n    }\r\n\r\n    public async signInWithProvider(providerName: string, settings: Partial<PopupSettings> = {}) {\r\n        return new Promise((resolve, reject) => {\r\n            const w = settings.width || 480;\r\n            const h = settings.height || 768;\r\n\r\n            // forward existing token for upgrading\r\n            const upgradingToken = this.token ? `?token=${this.token}` : \"\";\r\n\r\n            // Capitalize first letter of providerName\r\n            const title = `Login with ${(providerName[0].toUpperCase() + providerName.substring(1))}`;\r\n            const url = this.http['client']['getHttpEndpoint'](`${(settings.prefix || `${this.settings.path}/provider`)}/${providerName}${upgradingToken}`);\r\n\r\n            const left = (screen.width / 2) - (w / 2);\r\n            const top = (screen.height / 2) - (h / 2);\r\n\r\n            this.#_signInWindow = window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);\r\n\r\n            const onMessage = (event: MessageEvent) => {\r\n                // TODO: it is a good idea to check if event.origin can be trusted!\r\n                // if (event.origin.indexOf(window.location.hostname) === -1) { return; }\r\n\r\n                // require 'user' and 'token' inside received data.\r\n                if (event.data.user === undefined && event.data.token === undefined) { return; }\r\n\r\n                clearInterval(rejectionChecker);\r\n                this.#_signInWindow.close();\r\n                this.#_signInWindow = undefined;\r\n\r\n                window.removeEventListener(\"message\", onMessage);\r\n\r\n                if (event.data.error !== undefined) {\r\n                    reject(event.data.error);\r\n\r\n                } else {\r\n                    resolve(event.data);\r\n                    this.emitChange(event.data);\r\n                }\r\n            }\r\n\r\n            const rejectionChecker = setInterval(() => {\r\n                if (!this.#_signInWindow || this.#_signInWindow.closed) {\r\n                    this.#_signInWindow = undefined;\r\n                    reject(\"cancelled\");\r\n                    window.removeEventListener(\"message\", onMessage);\r\n                }\r\n            }, 200);\r\n\r\n            window.addEventListener(\"message\", onMessage);\r\n        });\r\n    }\r\n\r\n    public async signOut() {\r\n        this.emitChange({ user: null, token: null });\r\n    }\r\n\r\n    private emitChange(authData: Partial<AuthData>) {\r\n        if (authData.token !== undefined) {\r\n            this.token = authData.token;\r\n\r\n            if (authData.token === null) {\r\n                removeItem(this.settings.key);\r\n\r\n            } else {\r\n                // store key in localStorage\r\n                setItem(this.settings.key, authData.token);\r\n            }\r\n        }\r\n\r\n        this.#_events.emit(\"change\", authData);\r\n    }\r\n\r\n}\r\n"],"names":["createNanoEvents","getItem","__classPrivateFieldGet","__classPrivateFieldSet","__assign","__awaiter","removeItem","setItem"],"mappings":"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"}